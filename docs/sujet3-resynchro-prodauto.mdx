### Contexte

Dans le cadre de la mise en place de la norme RGPD, il y a eu la mise en place d'une purge sur la base de donnée contenant les contrats/devis ajoutés par les utilisateurs (DB2), or la base de donnée du datahub n'a pas subis ces memes mises à jours, et donc les données n'avaient pas été purgés de ce coté.
Le composant lié aux contrats et devis automobile (**prodauto**) fait partie des composants afféctés par cela.

Pour assurer la bonne **conformité** avec les exigences RGPD, il faut donc **resynchroniser** ces données supprimées en les réintégrant dans le processus de purge, afin qu’elles soient correctement prises en compte.

---

### Objectif

* Récuperer et ingérer /A EXPLIQUER\ un Unload de la base DB2 qui correspont aux données n'ayant pas été purgés.
* Générer un fichier **delta** qui identifie les données absentes ou non traitées dans la base actuelle, pour une purge complète et fiable.

---

### Contraintes techniques

* Réutilisation d'identifiants pour les 3 tables de prodauto (table des contrats, contrats à effet différé et devis)/
  Tant que la resynchronisation avec le Datahub n’a pas eu lieu, le Datahub conserve encore l’ancien contrat non purgé, ce qui fait qu'on peut avoir même identifiant pour plusieurs contrats différents (ancien et nouveau).
* La manipulation repose sur des **requêtes SQL** avec des jointures et des fonctions analytiques.

---

**A FINIR Il y aura ici des explications du job tpacon10**

zone: "ing"
origine: "maaf"
cal: "prodauto"
name: "contrat_tpacon10"
vars:
  table-name-source: "tpacon10"
  directory: "/${env}/ing/maaf/prodauto/rgpd/data_guide_contrat"
  table-cible: "data_guide_contrat_incoming"
  flux: "resynchro"
  date_arch: "31/12/2024"
  delay_reuse: "36"

stages:
  - stage: "suppression data_guide"
    type: "CLEAN_DIR_HDFS"
    condition: "modePattern==\"prepare\""
    params:
      directories:
        - "${directory}"
        - "${directory}/staging"
        - "${directory}/stagingArchives"
        - "${directory}/incoming"
        - "${directory}/reconcile"
        - "${directory}/base"
        - "${directory}/histo"
  - stage: "multi_data_prep"
    type: "MULTI_DATA_PREP"
    condition: "modePattern==\"prepare\""
    params:
      sources:
        - name: "resynchro_tpacon10"
          type: table
          table-name: "${flux}_${table-name-source}"
          schema-file: "schema/metcdc/tpacon10.yaml"
          directory: "/${env}/ing/maaf/prodauto/${flux}/tpacon10"
        - name: "metcdc_tpacon10_base"
          type: table
          table-name: "metcdc_${table-name-source}_base"
          schema-file: "schema/metcdc/tpacon10.yaml"
          directory: "/${env}/ing/maaf/prodauto/metcdc/tpacon10/base"
        - name: "metcdc_tpacon10_histo"
          type: table
          table-name: "metcdc_${table-name-source}_histo"
          schema-file: "schema/metcdc/tpacon10.yaml"
          directory: "/${env}/ing/maaf/prodauto/metcdc/tpacon10/histo"
      transformations:
        - name: "data_guide_contrat_incoming"
          type: parquet
          base: "/${env}/ing/maaf/prodauto/rgpd/data_guide_contrat/incoming"
          directory: "/${env}/ing/maaf/prodauto/rgpd/data_guide_contrat/incoming"
          schema-file: "schema/RGPD/data_guide_contrat_rgpd_incoming.yaml"
          table-name: "${table-cible}"
          query: "
                  SELECT 'contrat'                                                                                 AS ctymet,
                         t3.nsc                                                                                    AS nsc,
                         t3.ncnt                                                                                   AS ncnt,
                                Concat( '31/12/', Cast(Cast(Substr(t3.base_timestamp,1,4) AS INT) - 1 AS STRING) ) AS dpasarch,
                         ''                                                                                        AS dapurge,
                         date_format(CURRENT_TIMESTAMP,'yyyy-MM-dd HH:mm:ss')                                      AS date_ingestion
                  FROM   (
                                  SELECT   t2.nsc,
                                           t2.ncnt,
                                           t2.min_dnrdef,
                                           t2.max_dnrdef,
                                           t2.base_timestamp,
                                           Row_number()
                                             OVER (
                                               partition BY t2.nsc, t2.ncnt
                                               ORDER BY t2.base_timestamp ASC
                                               ) AS rn
                                  FROM     (
                                                  SELECT     j.nsc,
                                                              j.ncnt,
                                                              Min(j.dnrdef) OVER (partition BY j.nsc, j.ncnt)             AS min_dnrdef,
                                                              Max(j.dnrdef) OVER (partition BY j.nsc, j.ncnt)             AS max_dnrdef,
                                                              MAX(n.dtl__capxtimestamp) OVER (partition BY j.nsc, j.ncnt) AS base_timestamp
                                                  FROM       metcdc_tpacon10_histo j
                                                  INNER JOIN resynchro_tpacon10 n
                                                  ON         j.nsc = n.nsc
                                                  AND        j.ncnt = n.ncnt ) AS t2
                                  WHERE    add_months(t2.min_dnrdef, ${delay_reuse}) < t2.max_dnrdef ) AS t3
                  WHERE  t3.rn = 1
                  UNION ALL
                  SELECT 'contrat'                                             AS ctymet,
                         b.nsc                                                 AS nsc,
                         b.ncnt                                                AS ncnt,
                         cast('${date_arch}' AS string)                        AS dpasarch,
                         ''                                                    AS dapurge,
                         date_format(CURRENT_TIMESTAMP,'yyyy-MM-dd HH:mm:ss')  AS date_ingestion
                  FROM   metcdc_tpacon10_base b
                  WHERE  NOT EXISTS
                         (
                                SELECT 1
                                FROM   resynchro_tpacon10 i
                                WHERE  b.nsc = i.nsc
                                AND    b.ncnt = i.ncnt
                         )"

Voir schéma purge:
![shema](/img/schema.png)