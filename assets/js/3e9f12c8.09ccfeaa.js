"use strict";(self.webpackChunkmon_wiki=self.webpackChunkmon_wiki||[]).push([[226],{2232:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"sujet2-resynchro-prodauto","title":"sujet2-resynchro-prodauto","description":"Contexte","source":"@site/docs/sujet2-resynchro-prodauto.mdx","sourceDirName":".","slug":"/sujet2-resynchro-prodauto","permalink":"/rapportstage/sujet2-resynchro-prodauto","draft":false,"unlisted":false,"editUrl":"https://github.com/Darcodemonpote/rapportstage/edit/main/docs/sujet2-resynchro-prodauto.mdx","tags":[],"version":"current","frontMatter":{"hide_table_of_contents":true},"sidebar":"tutorialSidebar","previous":{"title":"sujet1-talend-dates","permalink":"/rapportstage/sujet1-talend-dates"},"next":{"title":"sujet3-resynchro-tpo2mrh","permalink":"/rapportstage/sujet3-resynchro-tpo2mrh"}}');var r=s(4848),a=s(8453),i=(s(6540),s(4907));const c={sideBySide:"sideBySide_Nt13",left:"left_d6UU",right:"right_CPEx"},o={hide_table_of_contents:!0},d=void 0,l={},u=[{value:"Contexte",id:"contexte",level:3},{value:"Objectif",id:"objectif",level:3},{value:"Contraintes techniques",id:"contraintes-techniques",level:3},{value:"Job <code>contrat_tpacon10</code> <em>(dont les &#39;$&#39; ont \xe9t\xe9s supprim\xe9s pour raisons techniques)</em>",id:"job-contrat_tpacon10-dont-les--ont-\xe9t\xe9s-supprim\xe9s-pour-raisons-techniques",level:2},{value:"Sch\xe9ma de purge",id:"sch\xe9ma-de-purge",level:3}];function p(e){const n={code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"contexte",children:"Contexte"}),"\n",(0,r.jsxs)(n.p,{children:["Dans le cadre de la mise en place de la norme RGPD, il y a eu la mise en place d'une purge sur la base de donn\xe9e contenant les contrats/devis ajout\xe9s par les utilisateurs (DB2), or la base de donn\xe9e du datahub n'a pas subis ces memes mises \xe0 jours, et donc les donn\xe9es n'avaient pas \xe9t\xe9 purg\xe9s de ce cot\xe9.\r\nLe composant li\xe9 aux contrats et devis automobile (",(0,r.jsx)(n.strong,{children:"prodauto"}),") fait partie des composants aff\xe9ct\xe9s par cela."]}),"\n",(0,r.jsxs)(n.p,{children:["Pour assurer la bonne ",(0,r.jsx)(n.strong,{children:"conformit\xe9"})," avec les exigences RGPD, il faut donc ",(0,r.jsx)(n.strong,{children:"resynchroniser"})," ces donn\xe9es supprim\xe9es en les r\xe9int\xe9grant dans le processus de purge, afin qu\u2019elles soient correctement prises en compte."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"objectif",children:"Objectif"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"R\xe9cuperer et ing\xe9rer /A EXPLIQUER\\ un Unload de la base DB2 qui correspont aux donn\xe9es n'ayant pas \xe9t\xe9 purg\xe9s."}),"\n",(0,r.jsxs)(n.li,{children:["G\xe9n\xe9rer un fichier ",(0,r.jsx)(n.strong,{children:"delta"})," qui identifie les donn\xe9es absentes ou non trait\xe9es dans la base actuelle, pour une purge compl\xe8te et fiable."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"contraintes-techniques",children:"Contraintes techniques"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"R\xe9utilisation d'identifiants pour les 3 tables de prodauto (table des contrats, contrats \xe0 effet diff\xe9r\xe9 et devis)/\r\nTant que la resynchronisation avec le Datahub n\u2019a pas eu lieu, le Datahub conserve encore l\u2019ancien contrat non purg\xe9, ce qui fait qu'on peut avoir m\xeame identifiant pour plusieurs contrats diff\xe9rents (ancien et nouveau)."}),"\n",(0,r.jsxs)(n.li,{children:["La manipulation repose sur des ",(0,r.jsx)(n.strong,{children:"requ\xeates SQL"})," avec des jointures et des fonctions analytiques."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.h2,{id:"job-contrat_tpacon10-dont-les--ont-\xe9t\xe9s-supprim\xe9s-pour-raisons-techniques",children:["Job ",(0,r.jsx)(n.code,{children:"contrat_tpacon10"})," ",(0,r.jsx)(n.em,{children:"(dont les '$' ont \xe9t\xe9s supprim\xe9s pour raisons techniques)"})]}),"\n",(0,r.jsxs)("div",{className:c.sideBySide,children:[(0,r.jsx)("div",{className:c.left,children:(0,r.jsx)(i.A,{language:"yaml",children:'\nzone: "ing"\norigine: "maaf"\ncal: "prodauto"\nname: "contrat_tpacon10"\nvars:\ntable-name-source: "tpacon10"\ndirectory: "/{env}/ing/maaf/prodauto/rgpd/data_guide_contrat"\ntable-cible: "data_guide_contrat_incoming"\nflux: "resynchro"\ndate_arch: "31/12/2024"\ndelay_reuse: "36"\n\nstages:\n- stage: "suppression data_guide"\n  type: "CLEAN_DIR_HDFS"\n  condition: "modePattern=="prepare""\n  params:\n    directories:\n      - "{directory}"\n      - "{directory}/staging"\n      - "{directory}/stagingArchives"\n      - "{directory}/incoming"\n      - "{directory}/reconcile"\n      - "{directory}/base"\n      - "{directory}/histo"\n- stage: "multi_data_prep"\n  type: "MULTI_DATA_PREP"\n  condition: "modePattern=="prepare""\n  params:\n    sources:\n      - name: "resynchro_tpacon10"\n        type: table\n        table-name: "{flux}_{table-name-source}"\n        schema-file: "schema/metcdc/tpacon10.yaml"\n        directory: "/{env}/ing/maaf/prodauto/{flux}/tpacon10"\n      - name: "metcdc_tpacon10_base"\n        type: table\n        table-name: "metcdc_{table-name-source}_base"\n        schema-file: "schema/metcdc/tpacon10.yaml"\n        directory: "/{env}/ing/maaf/prodauto/metcdc/tpacon10/base"\n      - name: "metcdc_tpacon10_histo"\n        type: table\n        table-name: "metcdc_{table-name-source}_histo"\n        schema-file: "schema/metcdc/tpacon10.yaml"\n        directory: "/{env}/ing/maaf/prodauto/metcdc/tpacon10/histo"\n    transformations:\n      - name: "data_guide_contrat_incoming"\n        type: parquet\n        base: "/{env}/ing/maaf/prodauto/rgpd/data_guide_contrat/incoming"\n        directory: "/{env}/ing/maaf/prodauto/rgpd/data_guide_contrat/incoming"\n        schema-file: "schema/RGPD/data_guide_contrat_rgpd_incoming.yaml"\n        table-name: "{table-cible}"\n        query: "\n                SELECT \'contrat\'                                                                                 AS ctymet,\n                       t3.nsc                                                                                    AS nsc,\n                       t3.ncnt                                                                                   AS ncnt,\n                              Concat( \'31/12/\', Cast(Cast(Substr(t3.base_timestamp,1,4) AS INT) - 1 AS STRING) ) AS dpasarch,\n                       \'\'                                                                                        AS dapurge,\n                       date_format(CURRENT_TIMESTAMP,\'yyyy-MM-dd HH:mm:ss\')                                      AS date_ingestion\n                FROM   (\n                                SELECT   t2.nsc,\n                                         t2.ncnt,\n                                         t2.min_dnrdef,\n                                         t2.max_dnrdef,\n                                         t2.base_timestamp,\n                                         Row_number()\n                                           OVER (\n                                             partition BY t2.nsc, t2.ncnt\n                                             ORDER BY t2.base_timestamp ASC\n                                             ) AS rn\n                                FROM     (\n                                                SELECT     j.nsc,\n                                                            j.ncnt,\n                                                            Min(j.dnrdef) OVER (partition BY j.nsc, j.ncnt)             AS min_dnrdef,\n                                                            Max(j.dnrdef) OVER (partition BY j.nsc, j.ncnt)             AS max_dnrdef,\n                                                            MAX(n.dtl__capxtimestamp) OVER (partition BY j.nsc, j.ncnt) AS base_timestamp\n                                                FROM       metcdc_tpacon10_histo j\n                                                INNER JOIN resynchro_tpacon10 n\n                                                ON         j.nsc = n.nsc\n                                                AND        j.ncnt = n.ncnt ) AS t2\n                                WHERE    add_months(t2.min_dnrdef, {delay_reuse}) < t2.max_dnrdef ) AS t3\n                WHERE  t3.rn = 1\n                UNION ALL\n                SELECT \'contrat\'                                             AS ctymet,\n                       b.nsc                                                 AS nsc,\n                       b.ncnt                                                AS ncnt,\n                       cast(\'{date_arch}\' AS string)                        AS dpasarch,\n                       \'\'                                                    AS dapurge,\n                       date_format(CURRENT_TIMESTAMP,\'yyyy-MM-dd HH:mm:ss\')  AS date_ingestion\n                FROM   metcdc_tpacon10_base b\n                WHERE  NOT EXISTS\n                       (\n                              SELECT 1\n                              FROM   resynchro_tpacon10 i\n                              WHERE  b.nsc = i.nsc\n                              AND    b.ncnt = i.ncnt\n                       )"\n'})}),(0,r.jsxs)("div",{className:c.right,children:[(0,r.jsxs)("h2",{children:["Explication du job ",(0,r.jsx)("code",{children:"contrat_tpacon10"})]}),(0,r.jsx)("p",{children:(0,r.jsxs)(n.p,{children:["Le job ",(0,r.jsx)("code",{children:"contrat_tpacon10"})," a \xe9t\xe9 mis en place pour assurer la\r\n",(0,r.jsx)("strong",{children:" resynchronisation des donn\xe9es de contrats automobiles "}),"\r\nli\xe9es au composant prodauto dans le cadre de la mise en conformit\xe9 RGPD.\r\nIl vise \xe0 r\xe9int\xe9grer dans le processus de purge les contrats qui avaient \xe9t\xe9 supprim\xe9s\r\nde la base ",(0,r.jsx)("strong",{children:"DB2"}),", mais qui sont toujours pr\xe9sents dans le ",(0,r.jsx)("strong",{children:"Datahub"}),"."]})}),(0,r.jsx)("h3",{children:"Fonctionnement g\xe9n\xe9ral"}),(0,r.jsx)("p",{children:(0,r.jsxs)(n.p,{children:["Ce job se base sur une ",(0,r.jsx)("strong",{children:"analyse crois\xe9e"})," entre l\u2019unload issu de DB2 (",(0,r.jsx)("code",{children:"resynchro_tpacon10"}),")\r\net les historiques/base existants du Datahub (",(0,r.jsx)("code",{children:"metcdc_tpacon10_histo"})," et ",(0,r.jsx)("code",{children:"metcdc_tpacon10_base"}),").\r\nIl est structur\xe9 en plusieurs \xe9tapes."]})}),(0,r.jsx)("h3",{children:"\xc9tape 1 \u2013 Nettoyage des r\xe9pertoires HDFS"}),(0,r.jsx)("p",{children:(0,r.jsxs)(n.p,{children:["Avant tout traitement, les r\xe9pertoires de travail li\xe9s \xe0 la table ",(0,r.jsx)("code",{children:"data_guide_contrat"})," sont nettoy\xe9s :"]})}),(0,r.jsxs)("ul",{children:[(0,r.jsxs)("li",{children:["R\xe9pertoires ",(0,r.jsx)("code",{children:"staging"}),", ",(0,r.jsx)("code",{children:"incoming"}),", ",(0,r.jsx)("code",{children:"reconcile"}),", ",(0,r.jsx)("code",{children:"base"}),", ",(0,r.jsx)("code",{children:"histo"}),", etc..."]}),(0,r.jsx)("li",{children:"\xc9vite les doublons ou conflits issus d\u2019un traitement pr\xe9c\xe9dent."})]}),(0,r.jsxs)("h3",{children:["\xc9tape 2 \u2013 Pr\xe9paration des donn\xe9es (stage ",(0,r.jsx)("code",{children:"multi_data_prep"}),")"]}),(0,r.jsx)("p",{children:"Cette \xe9tape charge les diff\xe9rentes sources n\xe9cessaires \xe0 la resynchronisation :"}),(0,r.jsx)("h4",{children:"Sources utilis\xe9es"}),(0,r.jsxs)("ul",{children:[(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"resynchro_tpacon10"})," : dump de DB2 contenant les contrats cens\xe9s avoir \xe9t\xe9 purg\xe9s"]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"metcdc_tpacon10_base"})," : \xe9tat actuel des contrats dans le Datahub (base)"]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"metcdc_tpacon10_histo"})," : historique des modifications sur ces contrats dans le Datahub"]})]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("strong",{children:"Objectif :"})," Comparer ces sources pour identifier deux cas distincts."]}),(0,r.jsxs)("h3",{children:["Transformation logique \u2013 G\xe9n\xe9ration du fichier ",(0,r.jsx)("code",{children:"data_guide_contrat_incoming"})]}),(0,r.jsx)("p",{children:(0,r.jsxs)(n.p,{children:["La logique de transformation SQL permet de g\xe9n\xe9rer le fichier ",(0,r.jsx)("code",{children:"data_guide_contrat_incoming"}),",\r\nqui contient les contrats \xe0 int\xe9grer dans le processus de purge."]})}),(0,r.jsx)("h4",{children:"Deux types de cas sont extraits :"}),(0,r.jsxs)("ol",{children:[(0,r.jsx)("li",{children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)("strong",{children:"Cas 1 \u2013 Contrats r\xe9utilis\xe9s"})," (m\xeame identifiant, contrat diff\xe9rent)",(0,r.jsx)("br",{}),"\r\nIdentifi\xe9s par une diff\xe9rence entre les dates de r\xe9f\xe9rence (",(0,r.jsx)("code",{children:"dnrdef"}),") min/max\r\net un d\xe9calage sup\xe9rieur au d\xe9lai (",(0,r.jsx)("code",{children:"delay_reuse"}),").",(0,r.jsx)("br",{}),"\r\nOn s\xe9lectionne le premier enregistrement chronologique (",(0,r.jsx)("code",{children:"ROW_NUMBER() = 1"}),") pour chaque identifiant."]})}),(0,r.jsx)("li",{children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)("strong",{children:"Cas 2 \u2013 Contrats inexistants dans DB2"})," (non purg\xe9s)",(0,r.jsx)("br",{}),"\r\nContrats encore pr\xe9sents dans le Datahub, mais absents du dump.",(0,r.jsx)("br",{}),"\r\nG\xe9n\xe9r\xe9s via un ",(0,r.jsx)("code",{children:"NOT EXISTS"})," entre la base ",(0,r.jsx)("code",{children:"metcdc"})," et le dump ",(0,r.jsx)("code",{children:"resynchro"}),"."]})})]}),(0,r.jsx)("p",{children:"Chaque ligne du fichier delta est enrichie avec les champs suivants :"}),(0,r.jsxs)("ul",{children:[(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"dpasarch"})," : date cible de purge (souvent 31/12/ann\xe9e pr\xe9c\xe9dente)"]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"dapurge"})," : champ vide, compl\xe9t\xe9 lors de la purge r\xe9elle"]}),(0,r.jsxs)("li",{children:[(0,r.jsx)("code",{children:"date_ingestion"})," : horodatage du job"]})]}),(0,r.jsx)("h3",{children:"R\xe9sultat attendu"}),(0,r.jsxs)("ul",{children:[(0,r.jsx)("li",{children:"Les contrats absents ou mal purg\xe9s sont correctement identifi\xe9s"}),(0,r.jsxs)("li",{children:["Un fichier Parquet est g\xe9n\xe9r\xe9 dans le r\xe9pertoire ",(0,r.jsx)("code",{children:"incoming"}),", pr\xeat \xe0 \xeatre int\xe9gr\xe9 dans la cha\xeene de purge RGPD"]})]}),(0,r.jsx)("h3",{children:"Liens avec les contraintes RGPD"}),(0,r.jsx)("p",{children:(0,r.jsx)(n.p,{children:"Ce job assure une tra\xe7abilit\xe9 compl\xe8te des contrats \xe0 purger et garantit que les \xe9ventuelles\r\nr\xe9utilisations d'identifiants n'interf\xe8rent pas avec les exigences RGPD."})}),(0,r.jsxs)("ul",{children:[(0,r.jsx)("li",{children:"Les donn\xe9es personnelles sont supprim\xe9es dans tous les syst\xe8mes concern\xe9s"}),(0,r.jsx)("li",{children:"Les fichiers de purge sont conformes et justifiables en cas d\u2019audit RGPD"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h3,{id:"sch\xe9ma-de-purge",children:"Sch\xe9ma de purge"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"schema",src:s(5776).A+"",width:"1152",height:"1290"})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},5776:(e,n,s)=>{s.d(n,{A:()=>t});const t=s.p+"assets/images/schema-7aa279751026c7f31939986e661446bb.png"}}]);